name: YouTube Playlist Otomatik GÃ¼ncelleyici

on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches:
      - main
    paths:
      - 'link.json'
  workflow_dispatch:

jobs:
  build-and-push-playlist:
    # BU SATIRLAR, WORKFLOW'A DEPOYA YAZMA Ä°ZNÄ° VERÄ°R
    permissions:
      contents: write

    runs-on: ubuntu-latest
    steps:
      - name: Depoyu Klonla
        uses: actions/checkout@v4

      - name: Gerekli araÃ§larÄ± kur (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: KlasÃ¶rleri HazÄ±rla
        run: |
          mkdir -p playlist
          rm -f playlist/*

      - name: M3U8 DosyalarÄ±nÄ± Ä°ndir
        run: |
          cat link.json | jq -c '.[]' | while read -r i; do
              name=$(echo "$i" | jq -r '.name')
              url=$(echo "$i" | jq -r '.url')
              echo "ðŸ“¥ '$name' kanalÄ± indiriliyor..."
              curl -fsSL "$url" \
                  -H "User-Agent: Mozilla/5.0" \
                  -H "Referer: https://live.artofknot.com/" \
                  -o "playlist/${name}.m3u8" || echo "âš ï¸ UYARI: '$name' kanalÄ± indirilemedi: $url"
          done

      - name: Ana Ã‡alma Listesini OluÅŸtur
        run: |
          MAIN_PLAYLIST_FILE="playlist/playlist.m3u"
          echo "#EXTM3U" > "$MAIN_PLAYLIST_FILE"
          
          for file in playlist/*.m3u8; do
              [ -f "$file" ] || continue
              name=$(basename "$file" .m3u8)
              github_raw_url="https://raw.githubusercontent.com/${{ github.repository }}/main/$file"
              
              echo "#EXTINF:-1 tvg-id=\"$name\" tvg-name=\"$name\",$name" >> "$MAIN_PLAYLIST_FILE"
              echo "$github_raw_url" >> "$MAIN_PLAYLIST_FILE"
          done
          echo "âœ… Ana Ã§alma listesi tamamlandÄ±."

      - name: DeÄŸiÅŸiklikleri Depoya YÃ¼kle
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add playlist/
          if ! git diff-index --quiet HEAD; then
            git commit -m "âœ… TV Listesi Otomatik GÃ¼ncellendi: $(date)"
            git pull # <<< DEÄžÄ°ÅžÄ°KLÄ°K BURADA YAPILDI
            git push
          else
            echo "ðŸ”„ DeÄŸiÅŸiklik yok, yÃ¼kleme atlandÄ±."
          fi
